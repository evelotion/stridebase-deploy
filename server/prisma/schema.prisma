// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Menambahkan ENUM baru untuk tipe penagihan
enum BillingType {
  COMMISSION
  INVOICE
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String
  password         String
  role             String            @default("customer")
  status           String            @default("active")
  createdAt        DateTime          @default(now())
  bookings         Booking[]
  reviews          Review[]
  stores           Store[]
  Address          Address[]
  requestsMade     ApprovalRequest[] @relation("RequestedBy")
  requestsResolved ApprovalRequest[] @relation("ResolvedBy")
  loyaltyPoint     LoyaltyPoint?
  notifications    Notification[]
  redeemedPromos   Promo[] // Relasi ke promo yang di-redeem
}

model LoyaltyPoint {
  id           String             @id @default(cuid())
  points       Int                @default(0)
  user         User               @relation(fields: [userId], references: [id])
  userId       String             @unique
  transactions PointTransaction[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model PointTransaction {
  id             String       @id @default(cuid())
  points         Int
  description    String
  createdAt      DateTime     @default(now())
  loyaltyPoint   LoyaltyPoint @relation(fields: [loyaltyPointId], references: [id])
  loyaltyPointId String
  booking        Booking?     @relation(fields: [bookingId], references: [id])
  bookingId      String?      @unique
}

model Store {
  id                String            @id @default(cuid())
  name              String
  description       String?
  headerImage       String?  
  location          String
  storeStatus       String            @default("pending")
  rating            Float             @default(0)
  servicesAvailable Int               @default(0)
  images            String[]
  latitude          Float?
  longitude         Float?
  schedule          Json?
  commissionRate    Float             @default(10.0)
  tier              StoreTier         @default(BASIC)
  billingType       BillingType       @default(COMMISSION) // <-- BARIS BARU
  createdAt         DateTime          @default(now())
   isFeatured        Boolean           @default(false)
  photoLimit        Int               @default(3)
  serviceLimit      Int               @default(5)
  bookings          Booking[]
  reviews           Review[]
  services          Service[]
  platformEarnings  PlatformEarning[]
  ownerUser         User?             @relation(fields: [ownerId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  ownerId           String?
  subscription      Subscription?
  invoices          Invoice[] // <-- BARIS BARU
  promos            Promo[]
}

// Model baru untuk sistem langganan (tier) yang sudah ada
model Subscription {
  id               String    @id @default(cuid())
  status           String
  currentPeriodEnd DateTime?
  store            Store     @relation(fields: [storeId], references: [id])
  storeId          String    @unique
  payments         Payment[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// --- MODEL BARU UNTUK INVOICE ---
model Invoice {
  id            String        @id @default(cuid())
  storeId       String
  store         Store         @relation(fields: [storeId], references: [id])
  invoiceNumber String        @unique
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  status        String        @default("DRAFT")
  totalAmount   Int
  notes         String?
  items         InvoiceItem[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  payment       Payment? // <-- TAMBAHKAN BARIS INI
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade) // <-- PERBAIKAN
  description String
  quantity    Int     @default(1)
  unitPrice   Int
  total       Int
}


model Booking {
  id               String           @id @default(cuid())
  totalPrice       Int
  status           String
  workStatus       WorkStatus       @default(RECEIVED)
  serviceName      String
  deliveryOption   String?
  scheduleDate     DateTime?
  user             User             @relation(fields: [userId], references: [id])
  userId           String
  store            Store            @relation(fields: [storeId], references: [id])
  storeId          String
  reviews          Review[]
  deliveryFee      Int              @default(0)
  payment          Payment?
  platformEarning  PlatformEarning?
  notifications    Notification[]
  pointTransaction PointTransaction?
  address          Address?         @relation(fields: [addressId], references: [id])
  addressId        String?
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  date      DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  booking   Booking  @relation(fields: [bookingId], references: [id])
  bookingId String   @unique
  userName  String
  partnerReply     String?
  partnerReplyDate DateTime?
  imageUrl         String?
}

model Promo {
  id             String    @id @default(cuid())
  code           String    @unique
  description    String
  discountType   String
  value          Int
  startDate      DateTime?
  endDate        DateTime?
  usageLimit     Int?
  usageCount     Int       @default(0)
  minTransaction Int?
  forNewUser     Boolean   @default(false)
  status         String    @default("active")
  store   Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId String? // ? berarti promo bisa dibuat oleh admin (global) atau oleh toko (spesifik)
  isRedeemed     Boolean   @default(false) // Menandai jika promo ini hasil redeem
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?   // Hanya untuk promo hasil redeem, agar tidak bisa dipakai orang lain
}

model Banner {
  id        String   @id @default(cuid())
  imageUrl  String
  linkUrl   String
  status    String   @default("active")
  createdAt DateTime @default(now())
}

model Address {
  id            String   @id @default(cuid())
  label         String
  recipientName String
  phoneNumber   String
  fullAddress   String
  city          String
  postalCode    String
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
    Booking       Booking[]
}

model Service {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Int
  shoeType    String
  store       Store   @relation(fields: [storeId], references: [id])
  storeId     String
}

model Payment {
  id               String        @id @default(cuid())
  booking          Booking?      @relation(fields: [bookingId], references: [id])
  bookingId        String?       @unique
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  subscriptionId   String?
   invoice          Invoice?      @relation(fields: [invoiceId], references: [id])
  invoiceId        String?       @unique
  amount           Int
  status           PaymentStatus @default(PENDING)
  provider         String
  transactionToken String?
  redirectUrl      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

model PlatformEarning {
  id             String   @id @default(cuid())
  bookingId      String   @unique
  storeId        String
  grossAmount    Int
  commissionRate Float
  earnedAmount   Float
  createdAt      DateTime @default(now())
  booking        Booking  @relation(fields: [bookingId], references: [id])
  store          Store    @relation(fields: [storeId], references: [id])
}

model ErrorLog {
  id          String   @id @default(cuid())
  statusCode  Int
  message     String
  stackTrace  String?  @db.Text
  requestInfo String?  @db.Text
  createdAt   DateTime @default(now())
}

model SecurityLog {
  id        String   @id @default(cuid())
  eventType String
  ipAddress String?
  details   String?  @db.Text
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // Contoh: "PRINTED_INVOICE"
  details   Json?    // Untuk menyimpan detail seperti nomor invoice
  createdAt DateTime @default(now())

  @@index([userId])
}

model ApprovalRequest {
  id            String   @id @default(cuid())
  requestedById String
  requestedBy   User     @relation("RequestedBy", fields: [requestedById], references: [id])
  actionType    String
  payload       Json
  status        String   @default("PENDING")
  resolvedById  String?
  resolvedBy    User?    @relation("ResolvedBy", fields: [resolvedById], references: [id])
  createdAt     DateTime @default(now())
  resolvedAt    DateTime?

  @@index([requestedById])
  @@index([resolvedById])
}

enum StoreTier {
  BASIC
  PRO
}

enum WorkStatus {
  RECEIVED
  WASHING
  DRYING
  QUALITY_CHECK
  READY_FOR_PICKUP
}

model Notification {
  id        String   @id @default(cuid())
  message   String
  readStatus Boolean  @default(false)
  linkUrl   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String?

  @@index([userId])
}