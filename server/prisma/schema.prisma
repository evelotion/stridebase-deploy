// StrideBase Schema

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum UserRole {
  customer
  mitra
  admin
  developer
}

enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  in_progress
  reviewed // Ditambahkan untuk konsistensi
}

enum WorkStatus {
  not_started
  in_progress
  completed
  pending_verification
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum StoreStatus {
  pending
  active
  inactive
  rejected
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Tier {
  BASIC
  PRO
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PromoScope {
  GLOBAL
  STORE_SPECIFIC
}

enum LogAction {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_SUCCESS
  USER_REGISTERED
  STORE_CREATED
  BOOKING_CREATED
  PAYMENT_SUCCESS
  ADMIN_ACTION
  DEVELOPER_ACTION
}

// Wallet System Enums
enum WalletTransactionType {
  CREDIT
  DEBIT
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
}


// Models
model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  name               String
  password           String
  role               UserRole          @default(customer)
  isEmailVerified    Boolean           @default(false)
  emailVerificationToken String?       @unique
  resetPasswordToken String?           @unique
  resetPasswordExpires DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  stores             Store[]
  bookings           Booking[]
  addresses          Address[]
  approvalRequests   ApprovalRequest[] @relation("RequestedApprovals")
  approvedRequests   ApprovalRequest[] @relation("ApprovedApprovals")
  securityLogs       SecurityLog[]
  notifications      Notification[]
  loyaltyPoints      LoyaltyPoint?
  reviews            Review[]
  requestedPayouts   PayoutRequest[]   @relation("RequestedPayouts")
  processedPayouts   PayoutRequest[]   @relation("ProcessedPayouts")
  status             String            @default("active") // Menambahkan status user
}

model Store {
  id                 String            @id @default(cuid())
  name               String
  location           String
  latitude           Float?
  longitude          Float?
  description        String?           @db.Text
  headerImageUrl     String?
  images             String[]          // PERBAIKAN: Menambahkan kolom images
  owner              User              @relation(fields: [ownerId], references: [id])
  ownerId            String
  storeStatus        StoreStatus       @default(pending)
  billingType        String            @default("COMMISSION")
  commissionRate     Float             @default(10)
  tier               Tier              @default(BASIC)
  rating             Float             @default(0)
  photoLimit         Int               @default(5) // Menambahkan batas foto
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  services           Service[]
  bookings           Booking[]
  schedules          StoreSchedule[]
  approvalRequests   ApprovalRequest[]
  reviews            Review[]
  promos             StorePromo[]
  wallet             StoreWallet?
  payoutRequests     PayoutRequest[]

  @@index([ownerId])
  @@index([storeStatus])
  @@index([tier])
}

model Address {
  id              String    @id @default(cuid())
  user            User      @relation(fields: [userId], references: [id])
  userId          String
  label           String?
  recipientName   String
  phoneNumber     String
  street          String
  city            String
  province        String
  postalCode      String
  country         String
  isPrimary       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  bookings        Booking[]
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  shoeType    String   // PERBAIKAN: Menambahkan kembali kolom shoeType
  duration    Int
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bookings    Booking[]

  @@index([storeId])
}

model StoreSchedule {
  id          String   @id @default(cuid())
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  dayOfWeek   String   // Mengubah ke String untuk kemudahan
  openTime    String
  closeTime   String
  isClosed    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, dayOfWeek])
}

model Booking {
  id                String             @id @default(cuid())
  user              User               @relation(fields: [userId], references: [id])
  userId            String
  store             Store              @relation(fields: [storeId], references: [id])
  storeId           String
  service           Service            @relation(fields: [serviceId], references: [id])
  serviceId         String
  serviceName       String             // Menambahkan salinan nama layanan
  deliveryOption    String             // self-delivery atau pickup
  scheduleDate      DateTime?          // Mengganti bookingTime
  totalPrice        Float
  notes             String?
  address           Address?           @relation(fields: [addressId], references: [id])
  addressId         String?
  status            BookingStatus      @default(pending)
  workStatus        WorkStatus         @default(not_started)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payment           Payment?
  platformEarning   PlatformEarning?
  notifications     Notification[]
  review            Review?
  walletTransaction WalletTransaction?

   @@index([userId])
  @@index([storeId])
  @@index([status])
}

model Payment {
  id              String        @id @default(cuid())
  booking         Booking       @relation(fields: [bookingId], references: [id])
  bookingId       String        @unique
  amount          Float
  status          String        @default("pending") // Mengubah ke String
  midtransToken   String?
  midtransOrderId String        @unique
  paymentMethod   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  invoice         Invoice?
}

model PlatformEarning {
  id           String   @id @default(cuid())
  booking      Booking  @relation(fields: [bookingId], references: [id])
  bookingId    String   @unique
  storeId      String
  earnedAmount Float
  createdAt    DateTime @default(now())
}

model ApprovalRequest {
  id            String         @id @default(cuid())
  store         Store?         @relation(fields: [storeId], references: [id])
  storeId       String?
  requestType   String
  details       Json
  status        ApprovalStatus @default(PENDING)
  requestedBy   User           @relation("RequestedApprovals", fields: [requestedById], references: [id])
  requestedById String
  reviewedBy    User?          @relation("ApprovedApprovals", fields: [reviewedById], references: [id])
  reviewedById  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model SecurityLog {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  action    LogAction
  ipAddress String?
  details   String?
  timestamp DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  booking   Booking? @relation(fields: [bookingId], references: [id])
  bookingId String?
  message   String
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LoyaltyPoint {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String   @unique
  points       Int      @default(0)
  updatedAt    DateTime @updatedAt
  transactions Json[]   // Menyimpan riwayat transaksi poin
}

model Review {
  id              String    @id @default(cuid())
  user            User      @relation(fields: [userId], references: [id])
  userId          String
  userName        String    // Menambahkan salinan nama user
  store           Store     @relation(fields: [storeId], references: [id])
  storeId         String
  booking         Booking   @relation(fields: [bookingId], references: [id])
  bookingId       String    @unique
  rating          Int
  comment         String?   @db.Text
  imageUrl        String?
  partnerReply    String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Promo {
  id              String       @id @default(cuid())
  code            String       @unique
  description     String
  discountType    String       // percentage atau fixed
  value           Float
  startDate       DateTime?
  endDate         DateTime?
  usageLimit      Int?
  usageCount      Int          @default(0)
  minTransaction  Float?
  forNewUser      Boolean      @default(false)
  status          String       @default("active") // active atau inactive
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  stores          StorePromo[]
}

model StorePromo {
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  promo     Promo    @relation(fields: [promoId], references: [id])
  promoId   String
  redeemed  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([storeId, promoId])
}

model Invoice {
  id            String    @id @default(cuid())
  invoiceNumber String    @unique
  storeId       String
  totalAmount   Float
  issueDate     DateTime
  dueDate       DateTime
  paidAt        DateTime?
  status        String    // SENT, PAID, OVERDUE
  items         Json
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  payment       Payment?  @relation(fields: [paymentId], references: [id])
  paymentId     String?   @unique
}

model GlobalSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json     // Menggunakan tipe JSONB
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  status      String   @default("active") // active atau inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Wallet System Models
model StoreWallet {
  id             String              @id @default(cuid())
  balance        Float               @default(0)
  store          Store               @relation(fields: [storeId], references: [id])
  storeId        String              @unique
  transactions   WalletTransaction[]
  payoutRequests PayoutRequest[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model WalletTransaction {
  id              String                @id @default(cuid())
  wallet          StoreWallet           @relation(fields: [walletId], references: [id])
  walletId        String
  amount          Float
  type            WalletTransactionType
  description     String
  booking         Booking?              @relation(fields: [bookingId], references: [id])
  bookingId       String?               @unique
  payoutRequest   PayoutRequest?        @relation(fields: [payoutRequestId], references: [id])
  payoutRequestId String?               @unique
  createdAt       DateTime              @default(now())
}

model PayoutRequest {
  id            String             @id @default(cuid())
  store         Store              @relation(fields: [storeId], references: [id])
  storeId       String
  wallet        StoreWallet        @relation(fields: [walletId], references: [id])
  walletId      String
  amount        Float
  status        PayoutStatus       @default(PENDING)
  requestedBy   User               @relation("RequestedPayouts", fields: [requestedById], references: [id])
  requestedById String
  processedBy   User?              @relation("ProcessedPayouts", fields: [processedById], references: [id])
  processedById String?
  transaction   WalletTransaction?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}