// StrideBase Schema

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum UserRole {
  customer
  mitra
  admin
  developer
}

enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  in_progress
}

enum WorkStatus {
  not_started
  in_progress
  completed
  pending_verification
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum StoreStatus {
  pending
  active
  inactive
  rejected
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Tier {
  BASIC
  PRO
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PromoScope {
  GLOBAL
  STORE_SPECIFIC
}

enum LogAction {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_SUCCESS
  USER_REGISTERED
  STORE_CREATED
  BOOKING_CREATED
  PAYMENT_SUCCESS
  ADMIN_ACTION
  DEVELOPER_ACTION
}

// Wallet System Enums
enum WalletTransactionType {
  CREDIT
  DEBIT
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
}


// Models
model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  name               String
  password           String
  role               UserRole          @default(customer)
  isEmailVerified    Boolean           @default(false)
  emailVerificationToken String?       @unique
  resetPasswordToken String?       @unique
  resetPasswordExpires DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  stores             Store[]
  bookings           Booking[]
  addresses          Address[]
  approvalRequests   ApprovalRequest[] @relation("RequestedApprovals")
  approvedRequests   ApprovalRequest[] @relation("ApprovedApprovals")
  securityLogs       SecurityLog[]
  notifications      Notification[]
  loyaltyPoints      LoyaltyPoint?
  reviews            Review[]
  requestedPayouts   PayoutRequest[]   @relation("RequestedPayouts")
  processedPayouts   PayoutRequest[]   @relation("ProcessedPayouts")
}

model Store {
  id                 String            @id @default(cuid())
  name               String
  location           String
  latitude           Float?
  longitude          Float?
  description        String?           @db.Text
  headerImageUrl     String?
  images             String[]
  owner              User              @relation(fields: [ownerId], references: [id])
  ownerId            String
  storeStatus        StoreStatus       @default(pending)
  billingType        String            @default("COMMISSION") // COMMISSION or INVOICE
  commissionRate     Float             @default(10) // In percentage
  tier               Tier              @default(BASIC)
  rating             Float             @default(0) // <-- TAMBAHKAN BARIS INI
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  services           Service[]
  bookings           Booking[]
  schedules          StoreSchedule[]
  approvalRequests   ApprovalRequest[]
  reviews            Review[]
  promos             StorePromo[]
  wallet             StoreWallet?
  payoutRequests     PayoutRequest[]
  @@index([ownerId])
  @@index([storeStatus])
  @@index([tier])
}

model Address {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  street      String
  city        String
  province    String
  postalCode  String
  country     String
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bookings    Booking[]
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  shoeType    String
  duration    Int // Duration in minutes
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bookings    Booking[]
  @@index([storeId])
}

model StoreSchedule {
  id          String   @id @default(cuid())
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  dayOfWeek   Int // 0 for Sunday, 1 for Monday, etc.
  openTime    String // "HH:MM" format
  closeTime   String // "HH:MM" format
  isClosed    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, dayOfWeek])
}

model Booking {
  id                String             @id @default(cuid())
  user              User               @relation(fields: [userId], references: [id])
  userId            String
  store             Store              @relation(fields: [storeId], references: [id])
  storeId           String
  service           Service            @relation(fields: [serviceId], references: [id])
  serviceId         String
  bookingTime       DateTime
  deliveryTime      DateTime?
  status            BookingStatus      @default(pending)
  workStatus        WorkStatus         @default(not_started)
  totalPrice        Float
  notes             String?
  address           Address?           @relation(fields: [addressId], references: [id])
  addressId         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  payment           Payment?
  platformEarning   PlatformEarning?
  notifications     Notification[]
  review            Review?
  walletTransaction WalletTransaction?
   @@index([userId])
  @@index([storeId])
  @@index([status])
}

model Payment {
  id              String        @id @default(cuid())
  booking         Booking       @relation(fields: [bookingId], references: [id])
  bookingId       String        @unique
  amount          Float
  status          PaymentStatus @default(pending)
  midtransToken   String?
  midtransOrderId String        @unique
  paymentMethod   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  invoice         Invoice?
}

model PlatformEarning {
  id           String   @id @default(cuid())
  booking      Booking  @relation(fields: [bookingId], references: [id])
  bookingId    String   @unique
  storeId      String
  earnedAmount Float
  createdAt    DateTime @default(now())
}

model ApprovalRequest {
  id          String         @id @default(cuid())
  store       Store          @relation(fields: [storeId], references: [id])
  storeId     String
  requestType String // e.g., 'STORE_DELETION', 'BILLING_TYPE_CHANGE'
  details     Json
  status      ApprovalStatus @default(PENDING)
  requestedBy User           @relation("RequestedApprovals", fields: [requestedById], references: [id])
  requestedById String
  reviewedBy  User?          @relation("ApprovedApprovals", fields: [reviewedById], references: [id])
  reviewedById String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model SecurityLog {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  action    LogAction
  ipAddress String?
  details   String?
  timestamp DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  booking   Booking? @relation(fields: [bookingId], references: [id])
  bookingId String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LoyaltyPoint {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  points    Int      @default(0)
  updatedAt DateTime @updatedAt
}

model Review {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  store           Store    @relation(fields: [storeId], references: [id])
  storeId         String
  booking         Booking  @relation(fields: [bookingId], references: [id])
  bookingId       String   @unique
  rating          Int
  comment         String?
  imageUrl        String?
  partnerReply    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Promo {
  id          String       @id @default(cuid())
  code        String       @unique
  description String
  type        PromoType
  value       Float
  maxDiscount Float?
  minPurchase Float
  validFrom   DateTime
  validUntil  DateTime
  usageLimit  Int
  timesUsed   Int          @default(0)
  scope       PromoScope
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  stores      StorePromo[]
}

model StorePromo {
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  promo     Promo    @relation(fields: [promoId], references: [id])
  promoId   String
  redeemed  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([storeId, promoId])
}

model Invoice {
  id        String    @id @default(cuid())
  storeId   String
  amount    Float
  dueDate   DateTime
  paidAt    DateTime?
  status    String // PENDING, PAID, OVERDUE
  items     Json
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  payment   Payment?  @relation(fields: [paymentId], references: [id])
  paymentId String?   @unique
}

model GlobalSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Wallet System Models
model StoreWallet {
  id             String              @id @default(cuid())
  balance        Float               @default(0)
  store          Store               @relation(fields: [storeId], references: [id])
  storeId        String              @unique
  transactions   WalletTransaction[]
  payoutRequests PayoutRequest[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model WalletTransaction {
  id              String                @id @default(cuid())
  wallet          StoreWallet           @relation(fields: [walletId], references: [id])
  walletId        String
  amount          Float
  type            WalletTransactionType
  description     String
  booking         Booking?              @relation(fields: [bookingId], references: [id])
  bookingId       String?               @unique
  payoutRequest   PayoutRequest?        @relation(fields: [payoutRequestId], references: [id])
  payoutRequestId String?               @unique
  createdAt       DateTime              @default(now())
}

model PayoutRequest {
  id            String             @id @default(cuid())
  store         Store              @relation(fields: [storeId], references: [id])
  storeId       String
  wallet        StoreWallet        @relation(fields: [walletId], references: [id])
  walletId      String
  amount        Float
  status        PayoutStatus       @default(PENDING)
  requestedBy   User               @relation("RequestedPayouts", fields: [requestedById], references: [id])
  requestedById String
  processedBy   User?              @relation("ProcessedPayouts", fields: [processedById], references: [id])
  processedById String?
  transaction   WalletTransaction?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}